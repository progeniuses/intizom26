<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raqobat - Life OS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåø</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        .competition-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .competition-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .competition-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .competition-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .competition-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .competitor-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            position: relative;
            transition: all 0.3s;
        }
        
        .competitor-card.winner {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
        }
        
        .competitor-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .competitor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .competitor-info h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .competitor-info .competitor-role {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .competitor-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-box-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }
        
        .stat-box-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .comparison-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .comparison-section h3 {
            font-size: 1.5rem;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .comparison-item {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .comparison-label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .comparison-value {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
        }
        
        .comparison-value.winner {
            color: var(--accent);
        }
        
        .vs-divider {
            font-size: 1.5rem;
            color: var(--text-muted);
            font-weight: 700;
        }
        
        .chart-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-box {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
        }
        
        .chart-box h4 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }
        
        .chart-container-small {
            height: 200px;
            position: relative;
        }
        
        @media (max-width: 1024px) {
            .competition-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üåø</div>
                <span>Life OS</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Asosiy</div>
                <div class="nav-item" onclick="location.href='/'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" onclick="location.href='/calendar'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Kalendar
                </div>
                <div class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Raqobat
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <header class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="breadcrumb">
                    üèÜ <span>Raqobat</span>
                </div>
            </div>
            <div class="topbar-actions">
                <div class="user-switcher" id="userSwitcher">
                    <div class="current-user" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="userAvatar">üë§</div>
                        <span id="userName">Bekzod</span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="user-menu" id="userMenu">
                        <div class="user-menu-item" onclick="switchUser(1)">
                            <div class="user-avatar">üë®</div>
                            <span>Bekzod</span>
                            <span class="user-check" id="check1">‚úì</span>
                        </div>
                        <div class="user-menu-item" onclick="switchUser(2)">
                            <div class="user-avatar">üë©</div>
                            <span>Shodiya</span>
                            <span class="user-check" id="check2"></span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="page-content">
            <div class="competition-container">
                <div class="competition-header">
                    <h1>üèÜ Raqobat</h1>
                    <p>Ikki foydalanuvchi natijalarini solishtiring</p>
                </div>

                <div class="competition-grid" id="competitionGrid">
                    <!-- Competitors will be rendered here -->
                </div>

                <div class="comparison-section">
                    <h3>üìä Taqqoslash</h3>
                    <div id="comparisonList">
                        <!-- Comparison items will be rendered here -->
                    </div>
                    
                    <div class="chart-comparison">
                        <div class="chart-box">
                            <h4>Bekzod - Haftalik</h4>
                            <div class="chart-container-small">
                                <canvas id="chartBekzod"></canvas>
                            </div>
                        </div>
                        <div class="chart-box">
                            <h4>Shodiya - Haftalik</h4>
                            <div class="chart-container-small">
                                <canvas id="chartShodiya"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let bekzodStats = {};
        let shodiyaStats = {};
        let bekzodChart, shodiyaChart;

        async function loadCompetitionData() {
            // Load last 30 days for both users
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            // Load Bekzod stats (user_id = 1)
            try {
                const bekzodRes = await fetch(`/api/daily-stats?user_id=1&start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`);
                bekzodStats = await bekzodRes.json();
            } catch (err) {
                console.error('Failed to load Bekzod stats', err);
                bekzodStats = [];
            }

            // Load Shodiya stats (user_id = 2)
            try {
                const shodiyaRes = await fetch(`/api/daily-stats?user_id=2&start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`);
                shodiyaStats = await shodiyaRes.json();
            } catch (err) {
                console.error('Failed to load Shodiya stats', err);
                shodiyaStats = [];
            }

            renderCompetition();
            renderCharts();
        }

        function calculateUserStats(stats) {
            const last7Days = stats.slice(-7);
            const totalCompleted = last7Days.reduce((sum, s) => sum + (s.todos_completed || 0), 0);
            const totalTodos = last7Days.reduce((sum, s) => sum + (s.todos_total || 0), 0);
            const avgCompletion = totalTodos > 0 ? Math.round((totalCompleted / totalTodos) * 100) : 0;
            const totalHabits = last7Days.reduce((sum, s) => sum + (s.habits_completed || 0), 0);
            const avgGoals = last7Days.reduce((sum, s) => sum + (s.goals_progress_avg || 0), 0) / (last7Days.length || 1);
            
            return {
                todos_completed: totalCompleted,
                todos_total: totalTodos,
                completion_rate: avgCompletion,
                habits_completed: totalHabits,
                goals_avg: Math.round(avgGoals)
            };
        }

        function renderCompetition() {
            const bekzod = calculateUserStats(bekzodStats);
            const shodiya = calculateUserStats(shodiyaStats);
            
            const grid = document.getElementById('competitionGrid');
            grid.innerHTML = `
                <div class="competitor-card ${bekzod.completion_rate >= shodiya.completion_rate ? 'winner' : ''}">
                    <div class="competitor-header">
                        <div class="competitor-avatar">üë®</div>
                        <div class="competitor-info">
                            <h2>Bekzod</h2>
                            <div class="competitor-role">Foydalanuvchi 1</div>
                        </div>
                    </div>
                    <div class="competitor-stats">
                        <div class="stat-box">
                            <div class="stat-box-value">${bekzod.completion_rate}%</div>
                            <div class="stat-box-label">Bajarilish</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${bekzod.todos_completed}</div>
                            <div class="stat-box-label">Bajarilgan</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${bekzod.habits_completed}</div>
                            <div class="stat-box-label">Odatlar</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${bekzod.goals_avg}%</div>
                            <div class="stat-box-label">Maqsadlar</div>
                        </div>
                    </div>
                </div>
                
                <div class="competitor-card ${shodiya.completion_rate > bekzod.completion_rate ? 'winner' : ''}">
                    <div class="competitor-header">
                        <div class="competitor-avatar">üë©</div>
                        <div class="competitor-info">
                            <h2>Shodiya</h2>
                            <div class="competitor-role">Foydalanuvchi 2</div>
                        </div>
                    </div>
                    <div class="competitor-stats">
                        <div class="stat-box">
                            <div class="stat-box-value">${shodiya.completion_rate}%</div>
                            <div class="stat-box-label">Bajarilish</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${shodiya.todos_completed}</div>
                            <div class="stat-box-label">Bajarilgan</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${shodiya.habits_completed}</div>
                            <div class="stat-box-label">Odatlar</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${shodiya.goals_avg}%</div>
                            <div class="stat-box-label">Maqsadlar</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Comparison
            const comparison = document.getElementById('comparisonList');
            comparison.innerHTML = `
                <div class="comparison-item">
                    <div class="comparison-value ${bekzod.completion_rate >= shodiya.completion_rate ? 'winner' : ''}">${bekzod.completion_rate}%</div>
                    <div class="vs-divider">VS</div>
                    <div class="comparison-value ${shodiya.completion_rate > bekzod.completion_rate ? 'winner' : ''}">${shodiya.completion_rate}%</div>
                    <div class="comparison-label" style="grid-column: 1 / -1; text-align: center; margin-top: 10px;">Bajarilish foizi</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-value ${bekzod.todos_completed >= shodiya.todos_completed ? 'winner' : ''}">${bekzod.todos_completed}</div>
                    <div class="vs-divider">VS</div>
                    <div class="comparison-value ${shodiya.todos_completed > bekzod.todos_completed ? 'winner' : ''}">${shodiya.todos_completed}</div>
                    <div class="comparison-label" style="grid-column: 1 / -1; text-align: center; margin-top: 10px;">Bajarilgan vazifalar</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-value ${bekzod.habits_completed >= shodiya.habits_completed ? 'winner' : ''}">${bekzod.habits_completed}</div>
                    <div class="vs-divider">VS</div>
                    <div class="comparison-value ${shodiya.habits_completed > bekzod.habits_completed ? 'winner' : ''}">${shodiya.habits_completed}</div>
                    <div class="comparison-label" style="grid-column: 1 / -1; text-align: center; margin-top: 10px;">Bajarilgan odatlar</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-value ${bekzod.goals_avg >= shodiya.goals_avg ? 'winner' : ''}">${bekzod.goals_avg}%</div>
                    <div class="vs-divider">VS</div>
                    <div class="comparison-value ${shodiya.goals_avg > bekzod.goals_avg ? 'winner' : ''}">${shodiya.goals_avg}%</div>
                    <div class="comparison-label" style="grid-column: 1 / -1; text-align: center; margin-top: 10px;">Maqsadlar o'rtacha</div>
                </div>
            `;
        }

        function renderCharts() {
            // Bekzod chart
            const bekzodCtx = document.getElementById('chartBekzod');
            if (bekzodChart) bekzodChart.destroy();
            
            const bekzodLast7 = bekzodStats.slice(-7);
            bekzodChart = new Chart(bekzodCtx, {
                type: 'line',
                data: {
                    labels: bekzodLast7.map((_, i) => `Kun ${i+1}`),
                    datasets: [{
                        label: 'Bajarilish %',
                        data: bekzodLast7.map(s => s.completion_rate || 0),
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#a1a1aa' } },
                        x: { ticks: { color: '#a1a1aa' } }
                    }
                }
            });
            
            // Shodiya chart
            const shodiyaCtx = document.getElementById('chartShodiya');
            if (shodiyaChart) shodiyaChart.destroy();
            
            const shodiyaLast7 = shodiyaStats.slice(-7);
            shodiyaChart = new Chart(shodiyaCtx, {
                type: 'line',
                data: {
                    labels: shodiyaLast7.map((_, i) => `Kun ${i+1}`),
                    datasets: [{
                        label: 'Bajarilish %',
                        data: shodiyaLast7.map(s => s.completion_rate || 0),
                        borderColor: 'rgba(99, 102, 241, 1)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#a1a1aa' } },
                        x: { ticks: { color: '#a1a1aa' } }
                    }
                }
            });
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('active');
        }

        function switchUser(userId) {
            // Just for UI, doesn't affect competition view
            toggleUserMenu();
        }

        loadCompetitionData();
    </script>
</body>
</html>

